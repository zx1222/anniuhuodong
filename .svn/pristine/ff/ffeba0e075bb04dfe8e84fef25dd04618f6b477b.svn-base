<?php

/**
 * Created by PhpStorm.
 * User: Miinno-10
 * Date: 2018/1/23
 * Time: 15:28
 */
namespace app\modules\ejiaonewyear\controllers;

use app\modules\ejiaonewyear\BL\Lottery;
use app\modules\ejiaonewyear\BL\StatusTransfer;
use Yii;
use yii\web\Controller;
use yii\helpers\Url;

class DefaultController extends Controller
{
    public $enableCsrfValidation = false;

    /**
     * Renders the index view for the module
     * @return string
     */
    public function init()
    {
        parent::init();
        $this->view->title = Yii::$app->params['site_name'];
    }

    public function beforeAction($action)
    {
        if (Yii::$app->user->isGuest) {
            return $this->redirect(Url::to(['oauth/index', 'forword' => urlencode(Url::current([], true))], true))->send();
        }
        return parent::beforeAction($action); // TODO: Change the autogenerated stub

    }

    /**
     * 活动首页
     * @return string
     */
    public function actionIndex()
    {
//        $is_end = StatusTransfer::isEnd();

        return $this->render('index');
    }

    /**
     * 活动抽奖
     */
    public function actionLottery()
    {
        if (Yii::$app->user->isGuest) {
            return;
        }
//        $data = Yii::$app->request->post();
//        if (!$data || $data['sign'] == md5(data['timestamp'] . 'newyear')) {
//            return;
//        }
//        if (!$data || $data['sign'] == md5(time() . 'newyear')) {
//            return;
//        }
        if (Yii::$app->request->isAjax && Yii::$app->request->referrer) {
            // 计算今天第几天
            StatusTransfer::markRenew();
            if (StatusTransfer::allowLottery() || StatusTransfer::getToDayStatus() % 10 == 0) {
                // 本日抽奖次数达到上线:不允许再抽
                return false;
            }

            if (!StatusTransfer::allowLottery() && StatusTransfer::getToDayPid() != 0) {
                // 本日已经获奖:可抽但不会中奖
                $result = Lottery::getBad();
                StatusTransfer::markPause();

            }
            if (!StatusTransfer::allowLottery() && StatusTransfer::getToDayPid() == 0) {
                // 可以正常抽奖
                $result = Lottery::run();
            }

            $prize['praisename'] = $result['praisename'];
            $prize['id'] = $result['id'];
            $prize['praiseimage'] = $result['praiseimage'];

            return json_encode($prize);
        }

    }

}